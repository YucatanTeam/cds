<!-- 
    body: object: request body sent as json
    bodyById: array of DOM input element IDs to make body from their values
    get: route for get method
    post: route for post method
    response: response of request. bind this to use
 -->


{#if !done}
    <div class="preloader-wrapper small active">
        <div class="spinner-layer spinner-yellow-only">
        <div class="circle-clipper left">
            <div class="circle"></div>
        </div><div class="gap-patch">
            <div class="circle"></div>
        </div><div class="circle-clipper right">
            <div class="circle"></div>
        </div>
        </div>
    </div>
{:elseif !error}
    <slot><!-- put whatever tag you want here --></slot>
{:else}
    <p>{error} , refresh the page!</p>
{/if}

<script>
export default {
    data() {
        return {
            done: false,
            get: null,
            response: null, // bind:response if you need the response
            error: null,
        }
    },
    onupdate({changed, current, previous}) {
        if(!previous) {
            const self = this;
            var {get} = self.get();
            if(get) {
                return fetch(get, {
                    method: "GET",
                    mode: "same-origin",
                    credentials: "same-origin",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    redirect: "follow",
                })
                .then(response => {
                    if(response.redirected) {
                        window.location.href = response.url;
                    }
                    return response
                })
                .then(response => {
                    var body = null;
                    var contentType = response.headers.get("content-type");
                    if(contentType && contentType.includes("application/json")) {
                        body = response.json();
                    }
                    return {status: response.status, body};
                })
                .then(response => {
                    self.set({ response });
                    self.fire("response", {err: null, response});
                })
                .catch(err => {
                    self.set({ error: err, response: null });
                    self.fire("response", {err, response: null});
                });
            }
        }
    }
}
</script>