<div class="row">
    <Card image="/public/img/privacy.png" col="s12 m10 offset-m1 l8 offset-l2">
        <Input col="s12" label="Page title" id="title" type="text" />
        <Editor id="content" initial="kossher" bind:feditor=feditor></Editor>
        <br><div class="divider"></div><br>
        <Editor id="en_content" initial="kambiz" bind:eneditor=eneditor></Editor>
        <a class="waves-effect waves-light yellow black-text btn">Submit</a>
    </Card>
</div>

<div class="row">
    <Card image="/public/img/privacy.png" col="s12 m10 offset-m1 l8 offset-l2">
        {#await getRoutes}
            <Loading small/>
        {:then routes}
            <h3>Routes</h3>
            <Select id="routes" label="routes" text="select a route" options={routes} on:select=loadRoute(event)/>
            {#if currentRoute}
                <Table highlight rows={5} actions={[
                    {icon: "delete", tooltip: "delete", action(obj, table) {
                        utils.fetch(`/page/${obj.route_id}/route/remove`, {})
                        .then(r=>{
                            if(r.status == 200) {
                                utils.toast("Done");
                                // utils.reload();
                            }
                            else utils.toast("something went wrong !");
                        })
                        .catch(err => utils.toast("something went wrong !"));
                    }}]}
                    content={currentRoute.items} search={["name"]}/>
                <br>
                <h5>Add an item to {currentRoute.name}</h5>
                {#await getPages}
                    <Loading small/>
                {:then pages}
                    <Search
                    data={pages}
                    label="page"
                    id="route-item-page"
                    on:result=route_item_add(event)/>
                {/await}
            {/if}
        {/await}
    </Card>
</div>

<script>
export default {
    data() {
        return {
            feditor:null,
            eneditor:null,
            utils,
            currentRoute: null,
            getRoutes: utils.fetch("/route/all")
            .then(res => {
                if(res.status != 200)
                    throw "not ok";
                else {
                    // route { items: [{name}], name, access }
                    
                    var routes = res.body;
                    var rows = [];
                    for(var rt of routes) {
                        rt.name = rt.title;
                        if(rt.access <= cdsuser.access) {
                            rows.push(rt)
                        }
                    }
                    return rows;
                }
                   
            })
            .catch(err => utils.toast("something went wrong !")),
            getPages: utils.fetch("/page/all")
            .then(res => {
                if(res.status != 200)
                    throw "not ok";
                else
                   return res.body;
            })
            .catch(err => utils.toast("something went wrong !")),
        }
    },
  
    methods: {
        loadRoute(currentRoute) {
            const self = this;
            const { getPages } = this.get();
            Promise.resolve(getPages).then(pages => {
                var items = [];
                for(var page of pages) {
                    if(page.route_id == currentRoute.id) {
                        items.push(page)
                    }
                }
                for(var it of items) {
                    it.actions = [true];
                }
                currentRoute.items = items;
                self.set({currentRoute});
            })
        },
        route_item_add(page) {
            if(page != null){
                const { currentRoute } = this.get();
                utils.fetch(`/route/${currentRoute.id}/item/add`, {page: page.route_id})
                .then(response => {
                    if (response.status != 200) {
                        utils.toast("something went wrong !")
                    } else {
                        utils.toast("Done")
                        utils.reload()
                    }
                })
            } else {
                utils.toast("page doesn't exist !")
            }
        }
    },
    components: {
        Editor: "../../tags/Editor.html",
        Select: "../../tags/Select.html",
        Table: "../../tags/Table.html",
        Loading: "../../tags/Loading.html",
        Card: "../../tags/Card.html",
        Modal: "../../tags/Modal.html",
        Form: "../../tags/Form.html",
        Input: "../../tags/Input.html",
        Search: "../../tags/Search.html",
        RequestBtn: "../../tags/RequestBtn.html"
        
    }
}
</script>