
<!-- set actions and bind content  -->
<div class="row">
    {#await getbody}
        <Loading small/>
    {:then contents}

            <!-- ======== THIS MODAL WILL TRIGGER ON EACH ACTION ======== -->
            <div id="{crudindex===1 ? "modaledit" :  crudindex===0 ? "modalcreate" : crudindex===4 ? "modalblock" : crudindex===5 ? "modalunblock" : "modaldelete"}" class="modal">
                <div class="modal-content">
                    <h4>{crudindex===1 ? "Edit" : ""}</h4>
                        
                        {#if crudindex === 2}
                            <h4>Confirm Delete</h4>
                            <p>Do you really want to delete the body #{objModal.id} ?</p>

                        {:elseif crudindex === 4}
                            <h4>Confirm Block</h4>
                            <p>Do you really want to block the tab #{objModal.id} and its contents ?</p>

                        {:elseif crudindex === 5}
                            <h4>Confirm Unblock</h4>
                            <p>Do you really want to unblock the tab #{objModal.id} and its contents ?</p>
                        
                        {:elseif crudindex === 1}
                            <div class="row">
                                <Card col="s12 m10 offset-m1 l10 offset-l1">
                                    {#if objModal}
                                    <!-- TODO :
                                            add => tags , en_tags , content , en_content , slug , en_slug of body
                                         -->
                                        <Form response={{}}>
                                            <Input col="s12" label="title" id="title" type="text" value={ objModal.title } disabled/>
                                            <Input col="s12" label="en_title" id="en_title" type="text" value={ objModal.en_title } disabled/>
                                            <Input col="s12" label="country_name" id="country_name" type="text" value={ objModal.country_name } disabled/>
                                            <Input col="s12" label="country_en_name" id="country_en_name" type="text" value={ objModal.country_en_name } disabled/>
                                        </Form>
                                    {/if}
                                </Card>
                            </div>
                        {/if}
                </div>
                <div class="modal-footer">
                    <button class="modal-close waves-effect waves-green btn-flat" on:click="action(objModal.id, objModal.tab_id)">{crudindex===1 ? "Update" : crudindex===2 ? "Delete" : crudindex===4 ? "Block" : crudindex===5 ?"Unblock" : ""}</button>
                </div>
            </div>

        <Table highlight rows={5}
            on:modal="open(event)"
            content={contents}
            search={["country_name", "country_en_name", "title", "en_title", "tabCUID", "bodyCUID", 
                     "bodyID","tab_id", "slug", "en_slug", "content", "en_content", "tags", 
                     "en_tags", "tabSTATUS", "bodySTATUS"]}
            actions={[
                                            /* ------------------------------------------
                                                list of all actions for body data table 
                                            ------------------------------------------
                                            */
                    // ==============================================================================================
                    // DELETE
                    // ==============================================================================================
                    {icon: "delete",tooltip: "delete", action(obj, component) {
                            //  : delete only content of a tab
                            var index = 2
                           component.fire("modal", {obj, index}) 
                            
                        }
                    }, 
                    // ==============================================================================================
                    // EDIT : for dev , admin and mod
                    // ==============================================================================================
                    {icon: "edit",tooltip: "edit", action(obj, component) {
                            //  : edit the content of a tab 
                            var index = 1
                            component.fire("modal", {obj, index})    
                        }
                    }, 
                    // ==============================================================================================
                    // BLOCK STATUS
                    // ==============================================================================================
                    {icon: "block",tooltip: "block", action(obj, component) {
                        //  : block a body
                                var index = 4
                                component.fire("modal", {obj, index})
                        }
                    },
                    // ==============================================================================================
                    // UNBLOCK STATUS
                    // ==============================================================================================
                    {icon: "beenhere",tooltip: "unblock", action(obj, component) {
                        // : unblock a body
                                var index = 5
                                component.fire("modal", {obj, index})
                        }
                    } 
                ]}
        />


            <!-- TODO : ops for body on existing tab : migration consultancy - language courses - cando services - cando certificate
                        only dev can create/delete/edit/block/unblock tab!
                        when a tab is blocked all its content is blocked too! 
                        also we need to redirect user to error not found page
                        when he/she try to load the block tab!
                        for admin tab title and country_name is disabled!
                        for dev the entire tab stuff is editable!
                        dev and admin can create new body for a tab!
                        need a dropdown list of all tabs!
                        tags , slug , content for creating new body!
                        add some space between this part and above part!
                        also use action method and crudindex!
                         -->

                    <!-- The toolbar will be rendered in this container. -->
                    <div id="toolbar-container"></div>
                    <!-- This container will become the editable. -->
                    <div id="editor">
                        <p>This is the initial editor content.</p>
                    </div>

    {:catch err}
        <p>Error {err.message}</p>
    {/await}
</div>

<script>
export default {
    data(){
        return {
            objModal: null,
            // 1 : edit body , 0 : create body , 2 : delete body , 
            // 4 : block body , 5 : unblock body , 6 : create tab , 
            // 7 : delete tab , 8 : edit tab , 9 : block tab , 10 : unblock tab
            crudindex: 0,
            getbody: utils.fetch("/body/getAll")
            .then(response => {
                    var contents = response.body;
                    var rows = [];
                    for(var cnt of contents) {
                            // [ DELETE , EDIT , BLOCK , UNBLOCK ]
                            cnt.actions = [
                                [5, 7].includes(cdsuser.access), 
                                [3, 5, 7].includes(cdsuser.access), // dev , admin and mod can edit the body and its related tab 
                                [7].includes(cdsuser.access) && (cnt.bodySTATUS === 1 || cnt.tabSTATUS === 1), // only dev : when a tab is unblocked then its content is unblocked too!
                                [7].includes(cdsuser.access) && (cnt.bodySTATUS === 0 || cnt.tabSTATUS === 0), // only dev : when a tab is blocked then its content is blocked too!

                            ]
                            cnt.created_at = moment(cnt.created_at).fromNow()
                            cnt.created_at = moment(cnt.updated_at).fromNow()
                            rows.push(cnt);
                    }
                    return rows;
                })
                .catch(err => utils.toast("something went wrong !")),
        }
    },
    methods:{
        open({obj, index}){
            this.set({crudindex: index, objModal: obj})
            var elems = document.querySelector('.modal');
            var instances = M.Modal.init(elems, {});
            instances.open();
        },
        action(id, tab_id){
            
            var {crudindex} = this.get()
            // get down the road with crudindex!!!
            if(crudindex === 1){
                
                const eltags = document.getElementById("tags");
                const elen_tags = document.getElementById("en_tags");
                const elslug = document.getElementById("slug");
                const elen_slug = document.getElementById("en_slug");
                const elcontent = document.getElementById("content");
                const elen_content = document.getElementById("en_content");

                const tags = eltags.value ? eltags.value : null;
                const en_tags = elen_tags.value ? elen_tags.value : null;
                const slug = elslug.value ? elslug.value : null;
                const en_slug = elen_slug.value ? elen_slug.value : null;
                const content = elcontent.value ? elcontent.value : null;
                const en_content = elen_content.value ? elen_content.value : null;
                
                utils.fetch("/body/edit", {tags, en_tags, slug, en_slug, content, en_content, id}).then((res)=>{
                    if(res.status!=200){
                        utils.toast("something went wrong !")
                    } else{
                        utils.toast("Done")
                        utils.reload()
                    }
               }).catch(err => utils.toast("something went wrong !"));
            } else if(crudindex === 0){

                const eltags = document.getElementById("tags");
                const elen_tags = document.getElementById("en_tags");
                const elslug = document.getElementById("slug");
                const elen_slug = document.getElementById("en_slug");
                const elcontent = document.getElementById("content");
                const elen_content = document.getElementById("en_content");

                const tags = eltags.value ? eltags.value : null;
                const en_tags = elen_tags.value ? elen_tags.value : null;
                const slug = elslug.value ? elslug.value : null;
                const en_slug = elen_slug.value ? elen_slug.value : null;
                const content = elcontent.value ? elcontent.value : null;
                const en_content = elen_content.value ? elen_content.value : null;

                utils.fetch("/body/add", {tags, en_tags, slug, en_slug, content, en_content, tab_id}).then((res)=>{
                    if(res.status!=200){
                        utils.toast("something went wrong !")
                    } else{
                        utils.toast("Done")
                        utils.reload()
                    }
               }).catch(err => utils.toast("something went wrong !"));
            } else if(crudindex === 4){
                utils.fetch(`/body/block/${id}`, {}).then((res)=>{
                    if(res.status!=200){
                        utils.toast("something went wrong !")
                    } else{
                        utils.toast("Done")
                        utils.reload()
                    }
                }).catch(err => utils.toast("something went wrong !"));
            } else if(crudindex === 5){
                utils.fetch(`/body/unblock/${id}`, {}).then((res)=>{
                    if(res.status!=200){
                        utils.toast("something went wrong !")
                    } else{
                        utils.toast("Done")
                        utils.reload()
                    }
                }).catch(err => utils.toast("something went wrong !"));
            } else if(crudindex === 6){
                utils.fetch(`/tab/add`, {}).then((res)=>{
                    if(res.status!=200){
                        utils.toast("something went wrong !")
                    } else{
                        utils.toast("Done")
                        utils.reload()
                    }
               }).catch(err => utils.toast("something went wrong !"));
            } else if(crudindex === 7){
                utils.fetch(`/tab/edit`, {tab_id}).then((res)=>{
                    if(res.status!=200){
                        utils.toast("something went wrong !")
                    } else{
                        utils.toast("Done")
                        utils.reload()
                    }
               }).catch(err => utils.toast("something went wrong !"));
            } else if(crudindex === 8){
                utils.fetch(`/tab/delete/${tab_id}`, {}).then((res)=>{
                    if(res.status!=200){
                        utils.toast("something went wrong !")
                    } else{
                        utils.toast("Done")
                        utils.reload()
                    }
               }).catch(err => utils.toast("something went wrong !"));
            } else if(crudindex === 9){
                utils.fetch(`/tab/block/${tab_id}`, {}).then((res)=>{
                    if(res.status!=200){
                        utils.toast("something went wrong !")
                    } else{
                        utils.toast("Done")
                        utils.reload()
                    }
               }).catch(err => utils.toast("something went wrong !"));
            } else if(crudindex === 10){
                utils.fetch(`/tab/unblock/${tab_id}`, {}).then((res)=>{
                    if(res.status!=200){
                        utils.toast("something went wrong !")
                    } else{
                        utils.toast("Done")
                        utils.reload()
                    }
               }).catch(err => utils.toast("something went wrong !"));
            } else{
                utils.fetch(`/body/delete/${id}`, {}).then((res)=>{
                    if(res.status!=200){
                        utils.toast("something went wrong !")
                    } else{
                        utils.toast("Done")
                        utils.reload()
                    }
               }).catch(err => utils.toast("something went wrong !"));
            }
            
        }
    },
    components: {
        Loading: "../../tags/Loading.html",
        Table: "../../tags/Table.html",
        Card: "../../tags/Card.html",
        Form: "../../tags/Form.html",
        Input: "../../tags/Input.html"
    }
}
</script>