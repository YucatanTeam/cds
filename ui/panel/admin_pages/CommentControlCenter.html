
<!-- set actions and bind content  -->
<div class="row">
    {#await getcomments}
        <Loading small/>
    {:then comments}

            <!-- ======== THIS MODAL WILL TRIGGER ON edit & create ACTION OF EACH ROW ======== -->
            <div id="{crudindex===1 ? "modaledit" :  crudindex===0 ? "modalcreate" : "modaldelete"}" class="modal">
                <div class="modal-content">
                    <h4>{crudindex===1 ? "Edit" : crudindex===0 ? "Create" : ""}</h4>
                        
                        {#if crudindex === 2}
                            <h4>Confirm Delete</h4>
                            <p>Do you really want to delete the comment #{objModal.id} ?</p>
                        
                        {:else}
                            <div class="row">
                                <Card col="s12 m10 offset-m1 l10 offset-l1">
                                    <Form response={{}}>
                                        <Input col="s12" label="Email" id="email" type="email" value={ objModal ? objModal.email : ""}/>
                                        <Input col="s12" label="name" id="name" type="text" value={ objModal ? objModal.name : ""}/>
                                        <textarea id="content" class="materialize-textarea">{ objModal ? objModal.content : ""}</textarea>
                                        <label for="content">Textarea</label>
                                    </Form>
                                </Card>
                            </div>
                        {/if}
                </div>
                <div class="modal-footer">
                    <button class="modal-close waves-effect waves-green btn-flat" on:click="action(objModal)">{crudindex===1 ? "Update" : crudindex===0 ? "Add" : "Delete"}</button>
                </div>
            </div>

    <!-- TODO add timeago -->
        <Table highlight rows={6}
            on:modal="open(event)"
            content={comments} 
            search={["name", "content", "email", "cuid", "id", "post_id"]}
            actions={[
                                            /* ------------------------------------------
                                                list of all actions for comment data table 
                                            ------------------------------------------
                                            */
                    // ==============================================================================================
                    // CREATE : only for dev ( must chek on server side using user access inside comment api routes )
                    // ==============================================================================================
                    {icon: "fiber_new",tooltip: "create", action(obj, component) {
                            var index = 0
                            component.fire("modal", {obj, index})
                        }
                    }, 
                    // ==============================================================================================
                    // DELETE
                    // ==============================================================================================
                    {icon: "delete",tooltip: "delete", action(obj, component) {
                            var index = 2
                           component.fire("modal", {obj, index}) 
                            
                        }
                    }, 
                    // ==============================================================================================
                    // EDIT : for dev , admin and mod
                    // ==============================================================================================
                    {icon: "edit",tooltip: "edit", action(obj, component) {
                            var index = 1
                            component.fire("modal", {obj, index})    
                        }
                    }, 
                    // ==============================================================================================
                    // BLOCK/UNBLOCK STATUS
                    // ==============================================================================================
                    {icon: "block",tooltip: "block", action(obj, component) {

                            
                        }
                    },
                    // ==============================================================================================
                    // DELETE ALL COMMENTS
                    // ==============================================================================================
                    {icon: "delete_forever",tooltip: "delete all", action(obj, component) {

                            // TODO delete all comments !!    
                            
                        }
                    },
                    // ==============================================================================================
                    // SHOW RELATED POST
                    // ==============================================================================================
                    {icon: "import_contacts",tooltip: "show related post", action(obj, component) {

                            // TODO show the post info in modal !!
                            
                        }
                    }, 
                ]}
        />
    {:catch err}
        <p>Error {err.message}</p>
    {/await}
</div>

<script>
export default {
    data(){
        return {
            objModal: null,
            crudindex: 0, // 1 : edit , 0 : create , 2 : delete
            getcomments: utils.fetch("/comment/getAll")
            .then(response => {
                    var comments = response.body;
                    var rows = [];
                    for(var cmnt of comments) {
                            // [ CREATE , DELETE , EDIT , BLOCK/UNBLOCK STATUS ]
                            // only dev can create new comment
                            cmnt.actions = [
                                [7].includes(cdsuser.access), 
                                [5, 7].includes(cdsuser.access), 
                                [3, 5, 7].includes(cdsuser.access), 
                                [5, 7].includes(cdsuser.access),
                                [3, 5, 7].includes(cdsuser.access),
                                [3, 5, 7].includes(cdsuser.access),

                            ]
                            rows.push(cmnt);
                    }
                    return rows;
                })
                .catch(err => utils.toast("something went wrong !")),
        }
    },
    methods:{
        open({obj, index}){
            this.set({crudindex: index, objModal: obj})
            var elems = document.querySelector('.modal');
            var instances = M.Modal.init(elems, {});
            instances.open();
        },
        action(obj){
            var {crudindex} = this.get()
            if(crudindex === 1 || crudindex === 0){
                utils.fetch("/comment/edit", obj).then((res)=>{
                    if(res.status!=200){
                        return utils.toast("something went wrong !")
                    } else{
                        utils.toast("Done")
                        utils.reload()
                    }
               })
            } else{
                utils.fetch("/comment/delete/cu", obj.cuid).then((res)=>{
                    if(res.status!=200){
                        return utils.toast("something went wrong !")
                    } else{
                        utils.toast("Done")
                        utils.reload()
                    }
               })
            }
            
        }
    },
    components: {
        Loading: "../../tags/Loading.html",
        Table: "../../tags/Table.html",
        Card: "../../tags/Card.html",
        Form: "../../tags/Form.html",
        Input: "../../tags/Input.html"
    }
}
</script>